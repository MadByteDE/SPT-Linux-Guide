#!/usr/bin/env bash

# # # # # # # # # 
# SPT-INSTALLER #
# # # # # # # # # 

TITLE="spt-installer"
AUTHOR="MadByte"
LICENSE="MIT"
VERSION="0.3.2"
DATE="2025-08-20"

# ANSI codes
BOLD="\e[1m"; UNDERLINE="\e[2m"; RESET="\e[0m"
RED="\e[31m"; GREEN="\e[32m"; BLUE="\e[36m"
YELLOW="\e[33m"; GRAY="\e[90m"

# Default config
declare -A CONFIG
CONFIG[pfx_dir]="${HOME}/Games/tarkov"
CONFIG[spt_dir]="drive_c/SPTarkov"
CONFIG[bsg_dir]="drive_c/Battlestate Games"
CONFIG[eft_dir]="${CONFIG[bsg_dir]}/Escape from Tarkov"
CONFIG[winedebug]="-all,err+all,fixme+all,debugstr+all"

declare -A URL
URL[umu-launcher]="https://github.com/Open-Wine-Components/umu-launcher/releases/download/1.2.9/umu-launcher-1.2.9-zipapp.tar"
URL[bsg-launcher]="https://prod.escapefromtarkov.com/launcher/download"
URL[spt-installer]="https://ligma.waffle-lord.net/SPTInstaller.exe"
URL[bsg-launcher-ico]="https://cdn2.steamgriddb.com/icon/33686c2d8930be81c843ffb7d4312605/32/256x256.png"
URL[spt-launcher-ico]="https://cdn2.steamgriddb.com/icon_thumb/ddd4f86cd0f978e85155cfa6c9f94e0c.png"
URL[spt-server-ico]="https://cdn2.steamgriddb.com/icon_thumb/9f7431ea593b8e57401c08f40adc6e34.png"
URL[server-script]="https://raw.githubusercontent.com/MadByteDE/SPT-Linux-Guide/refs/heads/SPTv4-dev/scripts/launch-server.sh"
URL[installer-script]="https://raw.githubusercontent.com/MadByteDE/SPT-Linux-Guide/refs/heads/SPTv4-dev/scripts/spt-installer"
URL[guide-repo]="https://github.com/MadByteDE/SPT-Linux-Guide"
URL[discord]="https://discord.com/invite/Xn9msqQZan"
readonly -A URL

# We don't want to run as root
if [[ "$(id -u)" -eq 0 ]]; then
    echo "This script is not supposed to be run as root!"
    exit 1
fi

# Shell options
shopt -s extglob

# Make sure to throw an error on SIGINT
trap int INT; int() { err "Interrupt received"; }


m_exit() {
    local status
    status=${1:-$?}

    # Save config
    save_config

    # Remove temp files
    [[ -d "${TMP_DIR}" ]] && m_rm -r "${TMP_DIR}"

    # Exit with passed status code
    exit "${status}"
}


m_chmod() {
    chmod "$@" &>> "${LOG_PATH}" || err "Command \"$*\" failed (status code $?)"
}


m_rm() {
    rm "$@" &>> "${LOG_PATH}" || err "Command \"$*\" failed (status code $?)"
}


m_curl() {
    curl --connect-timeout 30 -f "$@" &>> "${LOG_PATH}" || err "Command \"$*\" failed (status code $?)"
}


m_umu-run() {
    "${UMU_PATH}" "$@" &>> "${LOG_PATH}" || err "Command \"$*\" failed (status code $?)"
}


msg() {
    local filtered_str output
    output="${GRAY}[$TITLE]${RESET} ${*}"
    filtered_str=$(echo -e "${output}" | sed 's/\x1B\[[0-9;]\{1,\}[A-Za-z]//g')

    # Show in terminal & write to log
    echo -e "${output}"
    echo "${filtered_str}" &>> "${LOG_PATH}"
}


err() {
    local status pfx
    status=$?
    pfx="${BOLD}${RED}ERROR: ${RESET}"
    msg "${pfx}$1"
    msg "${pfx}See \"${LOG_PATH}\" for more details.${RESET}"
    m_exit ${status}
}


ask() {
    printf "${GRAY}[${TITLE}]${RESET} $* [y/n] "
    while true; do
        read -r -p "> " yn
        case $yn in
            [Yy]*) return 0 ;;  
            [Nn]*) msg "Aborted"; m_exit 0 ;;
        esac
    done
}


load_config() {
    local varname
    # Skip if no config exists
    [[ ! -f "${CONFIG_PATH}" ]] && return 0
    # Read lines & load values
    while read line; do
        if echo $line | grep -F = &>/dev/null; then
            varname=$(echo "$line" | cut -d '=' -f 1)
            CONFIG[$varname]="$(echo "${line//["\""]}" | cut -d '=' -f 2-)"
        fi
    done < "${CONFIG_PATH}"
}


save_config() {
    # Remove old config
    [[ -f "${CONFIG_PATH}" ]] && rm -f "${CONFIG_PATH}" || exit 1
    # Add new values
    for key in ${!CONFIG[@]}; do
        echo "${key}=\"${CONFIG[$key]}\"" >> "${CONFIG_PATH}" || exit 1
    done
}


init_paths() {
    # System directories
    DATA_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}"
    DATA_DIR="${DATA_HOME}/${TITLE}" && mkdir -p "${DATA_DIR}"
    CACHE_DIR="${XDG_CACHE_HOME:-${HOME}/.cache}/${TITLE}" && mkdir -p "${CACHE_DIR}"
    CONFIG_DIR="${XDG_CONFIG_HOME:-${HOME}/.config}/${TITLE}" && mkdir -p "${CONFIG_DIR}"
    TMP_DIR="${CACHE_DIR}/tmp" && mkdir -p "${TMP_DIR}"
    ICO_DIR="${DATA_HOME}/icons/hicolor/256x256/apps" && mkdir -p "${ICO_DIR}"
    APP_DIR="${DATA_HOME}/applications"

    # Prefix directories
    SPT_DIR="${CONFIG[pfx_dir]}/${CONFIG[spt_dir]}"
    BSG_DIR="${CONFIG[pfx_dir]}/${CONFIG[bsg_dir]}"
    EFT_DIR="${CONFIG[pfx_dir]}/${CONFIG[eft_dir]}"

    # File path variables
    LOG_PATH="${CACHE_DIR}/installer.log"
    SCRIPT_PATH="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" && pwd )"
    UMU_PATH=$(command -v umu-run || echo "${DATA_DIR}/umu/umu-run")
    CONFIG_PATH="${CONFIG_DIR}/prefix.conf"
}


install_umu() {
    msg "Downloading UMU Launcher..."
    
    # Download zipapp archive
    cd "${TMP_DIR}" || exit
    m_curl -LO "${URL[umu-launcher]}"

    # Extract & remove when done
    tar -xf "$(ls -- !("zipapp.tar"))" -C "../" || err "Failed to extract umu-launcher archive"
}


install_eft() {
    msg "Started \"Escape from Tarkov\" setup..."
    # Get prefix path (cached/default) and validate it
    opt_setprefix "${CONFIG[pfx_dir]}"

    if [[ ! -d "${CONFIG[pfx_dir]}" ]]; then
        # Initialize prefix
        msg "Initializing wine prefix..."
        m_umu-run wineboot -u || err "Failed to initialize wine prefix"
    fi

    # Install game dependencies
    if ! cat "${CONFIG[pfx_dir]}/winetricks.log" 2>/dev/null | grep -q "dotnet48"; then
        msg "Installing .NET 4.8 Runtime (this might take a while)..."
        m_umu-run winetricks -q dotnet48
    fi

    if ! cat "${CONFIG[pfx_dir]}/winetricks.log" | grep -q "vcrun2022"; then
        msg "Installing Microsoft Visual C++ 2015-2022 Redistributable..."
        m_umu-run winetricks -q vcrun2022
    fi

    # Add prefix update pop-up workaround
    msg "Adding window pop-up workaround..."
    m_umu-run reg add "HKLM\\Software\\Microsoft\\.NETFramework" /v "OnlyUseLatestCLR" /t "REG_DWORD" /d 0001 /f

    # Add mouse focus workaround
    msg "Adding mouse focus workaround to registry..."
    m_umu-run reg add "HKCU\\Software\\Wine\\X11 Driver" /v "UseTakeFocus" /t "REG_SZ" /d "N" /f
    
    # Download BSG Launcher if needed
    if [[ ! -f "${DATA_DIR}/BsgLauncher.exe" ]]; then
        msg "Downloading BSG Launcher..."
        cd "${DATA_DIR}" && m_curl -L "${URL[bsg-launcher]}" -o "BsgLauncher.exe"
    fi

    # Install BSG Launcher
    msg "Installing BSG Launcher..."
    m_umu-run "${DATA_DIR}/BsgLauncher.exe" /VERYSILENT

    # Re-initialize prefix for GE-Proton
    msg "Switching Proton version to \"GE-Proton\"..."
    export PROTONPATH="GE-Proton"
    m_umu-run wineboot -u

    # Copy icon to user icons directory
    if [[ ! -f "${ICO_DIR}/tarkov.png" ]]; then
        msg "Getting app icon from SteamGridDB..."
        cd "${ICO_DIR}" && m_curl -L "${URL[bsg-launcher-ico]}" -o "tarkov.png"
    fi

    # Create application shortcut
    local shortcut_path env_vars launch_args 

    msg "Creating application shortcut..."
    shortcut_path="${APP_DIR}/BSG - Launcher.desktop"
    env_vars=()
    env_vars+=("PROTONPATH=\"GE-Proton\"")
    env_vars+=("WINEPREFIX=\"${CONFIG[pfx_dir]}\"")

    launch_args=()
    launch_args+=("--disable-software-rasterizer")

    # Remove existing shortcut
    [[ -f "${shortcut_path}" ]] && m_rm -f "${shortcut_path}"

    # Write desktop file
    {   echo "[Desktop Entry]"
        echo "Categories=Game;ActionGame;Simulation"
        echo "Path=${BSG_DIR}/BsgLauncher"
        echo "Exec=env ${env_vars[*]} ${UMU_PATH} \"BsgLauncher.exe\" ${launch_args[*]}"
        echo "Name=BSG - Launcher"
        echo "Icon=tarkov"
        echo "Type=Application"
    } > "${shortcut_path}" && m_chmod +x "${shortcut_path}"

    msg "${GREEN}Done! ※\(^o^)/※${RESET}"
}


install_spt() {
    msg "Started \"SPTarkov\" setup..."
    # HACK: Needed to run the SPTInstaller.exe
    export DOTNET_BUNDLE_EXTRACT_BASE_DIR=""
    export DOTNET_ROOT=""

    opt_setprefix "${CONFIG[pfx_dir]}"

    if  [[ ! -d "${CONFIG[pfx_dir]}" ]]; then
        msg "${YELLOW}Prefix directory at \"${CONFIG[pfx_dir]}\" does not exist.${RESET}"
        msg "Make sure to install EFT first!"
        err "Wine prefix not found"
    elif [[ ! -d "${EFT_DIR}" ]]; then
        msg "${YELLOW}Looks like Escape from Tarkov is not installed.${RESET}"
        msg "Make sure to install the game client with the BSG Launcher!"
        err "Tarkov game files not found"
    elif [[ -d "${SPT_DIR}" ]]; then
        msg "${YELLOW}SPTarkov directory already exists.${RESET}"
        msg "${YELLOW}If you want to reinstall, make sure to remove the old installation first!${RESET}"
        err "SPTarkov directory already exists."
    fi

    # Download SPT Installer
    if ! [[ -f "${DATA_DIR}/SPTInstaller.exe" ]]; then
        msg "Downloading SPTInstaller.exe..."
        cd "${DATA_DIR}" && m_curl -LO "${URL[spt-installer]}"
    fi

    # Install dependencies
    if ! cat "${CONFIG[pfx_dir]}/winetricks.log" 2>/dev/null | grep -q "dotnetdesktop8"; then
        msg "Installing .NET Desktop 8 Runtime..."
        m_umu-run winetricks -q dotnetdesktop8
    fi

    if ! cat "${CONFIG[pfx_dir]}/winetricks.log" | grep -q "dotnetdesktop9"; then
        msg "Installing .NET Desktop 9 Runtime..."
        m_umu-run winetricks -q dotnetdesktop9
    fi

    # Add DLL overrides
    msg "Adding DLL overrides to registry..."
    m_umu-run reg add "HKCU\\Software\\Wine\\DllOverrides" /v "winhttp" /t "REG_SZ" /d "native,builtin" /f

    # HACK: UMU-Proton fails to run the SPTInstaller, so we have to switch to GE-Proton instead
    export PROTONPATH="GE-Proton"

    # Run SPT Installer
    msg "Launching SPT Installer..."
    m_umu-run "${DATA_DIR}/SPTInstaller.exe" installpath="C:\\SPTarkov" || err "Failed to launch SPT Installer"

    # Install server launch script
    cd "${SPT_DIR}" && m_curl -LO "${URL[server-script]}"
    m_chmod +x "${SPT_DIR}/launch-server.sh"

    # Copy icon to user icons directory
    if [[ ! -f "${ICO_DIR}/spt_launcher.png" ]] || [[ ! -f "${ICO_DIR}/spt_server.png" ]]; then
        msg "Getting app icons from SteamGridDB..."
        cd "${ICO_DIR}" && m_curl -L "${URL[spt-launcher-ico]}" -o "spt_launcher.png"
        cd "${ICO_DIR}" && m_curl -L "${URL[spt-server-ico]}" -o "spt_server.png"
    fi

    # Create application shortcuts
    local shortcut_path env_vars launch_args 
    msg "Creating application shortcuts..."

    # SPT Launcher
    env_vars=()
    env_vars+=("PROTONPATH=\"GE-Proton\"")
    env_vars+=("PROTON_USE_XALIA=0")
    env_vars+=("DOTNET_BUNDLE_EXTRACT_BASE_DIR=")
    env_vars+=("DOTNET_ROOT=")
    env_vars+=("WINEDEBUG=\"${CONFIG[winedebug]}\"")
    env_vars+=("WINEPREFIX=\"${CONFIG[pfx_dir]}\"")

    launch_args=()

    shortcut_path="${APP_DIR}/SPTarkov - Launcher.desktop"

    # Remove existing shortcut
    [[ -f "${shortcut_path}" ]] && m_rm -f "${shortcut_path}"

    # Write desktop file
    {   echo "[Desktop Entry]"
        echo "Categories=Game;ActionGame;Simulation"
        echo "Path=${SPT_DIR}"
        echo "Exec=env ${env_vars[*]} ${UMU_PATH} \"SPT.Launcher.exe\" ${launch_args[*]}"
        echo "Name=SPTarkov - Launcher"
        echo "Icon=spt_launcher"
        echo "Type=Application"
    } > "${shortcut_path}" && m_chmod +x "${shortcut_path}"
    
    # SPT Server
    shortcut_path="${APP_DIR}/SPTarkov - Server.desktop"

    # Remove existing shortcut
    [[ -f "${shortcut_path}" ]] && m_rm -f "${shortcut_path}"

    # Write desktop file
    {   echo "[Desktop Entry]"
        echo "Categories=Game;ActionGame;Simulation"
        echo "Path=${SPT_DIR}"
        echo "Exec=\"${SPT_DIR}/launch-server.sh\""
        echo "Name=SPTarkov - Server"
        echo "Icon=spt_server"
        echo "Type=Application"
    } > "${shortcut_path}" && m_chmod +x "${shortcut_path}"

    msg "${GREEN}Done! ※\(^o^)/※${RESET}"
}


uninstall_eft() {
    local no_prompt
    no_prompt="${1:-$NO_PROMPT}"
    if [[ "${no_prompt}" != 1 ]]; then
        # Warn user before continuing
        msg "${BOLD}This action will uninstall \"Escape from Tarkov\" from your system!${RESET}"
        msg "Prefix directory: ${UNDERLINE}${CONFIG[pfx_dir]}${RESET}"
        ask "Do you want to continue?"
    fi

    msg "Uninstalling \"Escape from Tarkov\"..."
    [[ -d "${BSG_DIR}" ]] && m_rm -r "${BSG_DIR}"

    msg "Removing shortcut..."
    app_path="${APP_DIR}/BSG - Launcher.desktop"
    [[ -f "${app_path}" ]] && m_rm -f "${app_path}"

    [[ "${no_prompt}" != 1 ]] && msg "${GREEN}Done!${RESET}"
}


uninstall_spt() {
    local no_prompt
    no_prompt="${1:-$NO_PROMPT}"
    if [[ "${no_prompt}" != 1 ]]; then
        msg "${BOLD}This action will uninstall \"SPTarkov\" from your system!${RESET}"
        msg "Prefix directory: ${UNDERLINE}${CONFIG[pfx_dir]}${RESET}"
        ask "Do you want to continue?"
    fi

    msg "Uninstalling \"SPTarkov\"..."
    [[ -d "${SPT_DIR}" ]] && m_rm -r "${SPT_DIR}"

    msg "Removing shortcuts..."
    local apps app_path
    apps=("SPTarkov - Launcher.desktop" "SPTarkov - Server.desktop")
    for app in "${apps[@]}"; do
        app_path="${APP_DIR}/${app}"
        [[ -f "${app_path}" ]] && m_rm -f "${app_path}"
    done

    [[ "${no_prompt}" != 1 ]] && msg "${GREEN}Done!${RESET}"
}


opt_setprefix() {
    local path
    path="${1}"

    if [[ -d "${path}" ]]; then
        [[ ! -f "${path}/system.reg" ]] && err "Invalid prefix directory: \"${path}\""
    fi
        
    # Update WINEPREFIX environment variable
    export WINEPREFIX="${path}"

    # Update prefix config
    CONFIG[pfx_dir]="${path}"

    # Update paths
    init_paths || err "Failed to initialize script paths"

    msg "Prefix path has been set to \"${CONFIG[pfx_dir]}\""
}


opt_install() {
    # SYNTAX: spt-additions install spt -p ~/Games/sptarkov
    local option="$1" && shift

    while getopts ":p:e:a:h:-" subopt; do
        case ${subopt} in
            p) CONFIG[pfx_dir]="${OPTARG}";;
            e) opt_setenv "${OPTARG}";;
            a) opt_setargs "${OPTARG}";;
            h) opt_help "install" ;;
            -*)
                case "${OPTARG}" in
                    help) opt_help "install";;
                    *) err "Invalid option: --${OPTARG}" ;;
                esac
            ;;
        esac
    done
    
    case "${option}" in
        eft)
            # Install umu-launcher if needed
            [[ ! -f "${UMU_PATH}" ]] && install_umu
            # Launch setup
            install_eft
        ;;
        spt)
            # Install umu-launcher if needed
            [[ ! -f "${UMU_PATH}" ]] && install_umu
            # Launch setup
            install_spt
        ;;
        *) err "Invalid argument \"${option}\". (Available options: eft|spt)" ;;
    esac
}


opt_uninstall() {
    # SYNTAX: spt-additions uninstall spt -p ~/Games/sptarkov
    local option="$1" && shift

    while getopts ":p:h:-:" subopt; do
        case ${subopt} in
            p) opt_setprefix "${OPTARG}";;
            h) opt_help "uninstall" ;;
            -)
                case "${OPTARG}" in
                    help) opt_help "uninstall";;
                    no-prompt) export NO_PROMPT=1; msg "\"NO_PROMPT\" option set" ;;
                    *) err "Invalid option: --${OPTARG}" ;;
                esac
            ;;
        esac
    done
    
    case "${option}" in
        eft) uninstall_eft ;;
        spt) uninstall_spt ;;
        all)
            if ! [ "${NO_PROMPT}" = 1 ]; then
                # Warn user before continuing
                msg "${BOLD}This action will remove the installed wine prefix!${RESET}"
                msg "The following directory will be deleted ${BOLD}permanently${RESET}:"
                msg "${UNDERLINE}${CONFIG[pfx_dir]}${RESET}"
                ask "Do you want to continue?"
            fi

            uninstall_eft 1
            uninstall_spt 1

            msg "Removing Prefix directory..."
            [[ -d "${CONFIG[pfx_dir]}" ]] && m_rm -r "${CONFIG[pfx_dir]}"
            [[ "${NO_PROMPT}" != 1 ]] && msg "${GREEN}Done!${RESET}"
        ;;
        *) err "Invalid option \"${option}\". (Available options: eft|spt|all)" ;;
    esac
}


opt_run() {
    # spt-additions run spt --launcher -e "" -a ""
    # spt-additions run spt --server -e "" -a ""
    # spt-additions run eft -a "--disable-software-rasterizer"
    msg "run option is not implemented yet"
}


opt_patch() {
    # spt-additions patch -d ~/Games/sptarkov/drive_c/SPTarkov
    # spt-additions patch (saved pfx + default spt directory)
    msg "patch option is not implemented yet"
}


opt_shortcut() {
    # spt-additions shortcut spt --launcher -e "" -a ""
    # spt-additions shortcut spt --server -e "" -a ""
    msg "shortcut option is not implemented yet"
}


opt_clean() {
    # SYNTAX: spt-additions clean --config
    local option="$1" && shift

    while getopts ":p:h:-" subopt; do
        case ${subopt} in
            p) opt_setprefix "${OPTARG}";;
            h) opt_help "clean" ;;
            -)
                case "${OPTARG}" in
                    help) opt_help "clean";;
                    no-prompt) export NO_PROMPT=1; msg "\"NO_PROMPT\" option set" ;;
                    *) err "Invalid option: --${OPTARG}" ;;
                esac
            ;;
        esac
    done

    case "${option}" in
        cache)
            msg "Removing Cache directory..."
            [[ -d "${CACHE_DIR}" ]] && m_rm -r "${CACHE_DIR}"
            [[ "${NO_PROMPT}" != 1 ]] && msg "${GREEN}Done!${RESET}"
        ;;
        config)
            msg "Removing config directory..."
            [[ -d "${CONFIG_DIR}" ]] && m_rm -r "${CONFIG_DIR}"
            [[ "${NO_PROMPT}" != 1 ]] && msg "${GREEN}Done!${RESET}"
        ;;
        data)
            msg "Removing data directory..."
            [[ -d "${DATA_DIR}" ]] && m_rm -r "${DATA_DIR}"
            [[ "${NO_PROMPT}" != 1 ]] && msg "${GREEN}Done!${RESET}"
        ;;
        all)
            if [[ "${NO_PROMPT}" != 1 ]]; then
                # Warn user before continuing
                msg "${BOLD}This action will remove the SPT/EFT wine prefix, all cached files & all game shortcuts!${RESET}"
                msg "The following directories will be deleted ${BOLD}permanently${RESET}:"
                msg "    > ${UNDERLINE}${CONFIG[pfx_dir]}${RESET}"
                msg "    > ${UNDERLINE}${DATA_DIR}${RESET}"
                msg "    > ${UNDERLINE}${CACHE_DIR}${RESET}"
                ask "Do you want to continue?"
            fi
            opt_clean "data" 1
            opt_clean "cache" 1
            opt_clean "config" 1
            [[ "${NO_PROMPT}" != 1 ]] && msg "${GREEN}Done!${RESET}"
        ;;
        *)
            err "Invalid option \"${option}\". (Available options: cache|config|data|all)"
        ;;
    esac
}


opt_selfupdate() {
    if [[ "${NO_PROMPT}" != 1 ]]; then
        msg "${YELLOW}Not fully implemented yet${RESET}"
        msg
        msg "> The script will attempt to download the latest VERSION available here:"
        msg "> ${UNDERLINE}${URL[installer-script]}${RESET}"
        msg
        msg "> This feature is ${BOLD}NOT${RESET} fully implemented yet & won't validate the new script file!"
        msg
        ask "Do you want to continue?"
    fi
    msg "Updating script..."
    cd "${SCRIPT_PATH}" && m_curl -LO "${URL[installer-script]}"
    m_chmod +x "${SCRIPT_PATH}"
    [[ "${no_prompt}" != 1 ]] && msg "${GREEN}Done! ※\(^o^)/※${RESET}"
}


opt_help() {
    # spt-additions help uninstall
    local option="${1}"
    case "${option}" in
        install) ;;
        uninstall) ;;
        shortcut) ;;
        run) ;;
        patch) ;;
        clean) ;;
        "")
            msg "Standalone EFT/SPT installer script using UMU-Launcher and Proton."
            msg "${BOLD}Example usage: ${YELLOW}spt-installer -p ~/Games/tarkov -i eft${RESET}"
            msg
            msg "${BOLD}OPTIONS:${RESET}"
            msg "   ${BOLD}install${RESET}              - Available arguments: eft|spt"
            msg "   ${BOLD}uninstall${RESET}            - Available arguments: eft|spt|all"
            msg "   ${BOLD}shortcut${RESET}             - "
            msg "   ${BOLD}run${RESET}                  - "
            msg "   ${BOLD}patch${RESET}                - "
            msg "   ${BOLD}clean${RESET}                - Available arguments: data|cache|config|all"
            msg "   ${BOLD}-p${RESET} (Prefix)          - Set a custom path for the wine prefix"
            msg "   ${BOLD}--self-update${RESET}        - Updates this installer script"
            msg "   ${BOLD}--no-prompt${RESET}          - Disable interactive prompt messages"
            msg "   ${BOLD}-h | --help${RESET}          - Print this help message"
            msg "   ${BOLD}-v | --VERSION${RESET}       - Print the VERSION info message"
            msg
            msg "${YELLOW}[!] This script is made by the SPT community & is NOT offically supported by the mod developers!${RESET}"
            msg
            msg "For more details and help, visit:"
            msg "  > ${BOLD}${URL[guide-repo]}${RESET}"
            msg
            msg "Join the SPT Discord server:"
            msg "  > ${BOLD}${URL[discord]}${RESET}"
        ;;
        *) msg "Invalid argument: ${option}. Available arguments: install|uninstall|shortcut|run|patch|clean" ;;
    esac
}


opt_version() {
    msg "${BOLD}Version: ${RESET}${VERSION} (${DATE})"
    msg "${BOLD}Author: ${RESET}${AUTHOR}"
    msg "${BOLD}License: ${RESET}${LICENSE}"
}


handle_opts() {
    local option
    option="${1}" && shift

    case "$option" in
        install) opt_install "$@" ;;
        uninstall) opt_uninstall "$@" ;;
        run) opt_run "$@" ;;
        patch) opt_patch "$@" ;;
        shortcut) opt_shortcut "$@" ;;
        clean) opt_clean "$@" ;;
        self-update) opt_selfupdate ;;
        version) opt_version ;;
        help) opt_help "$@";;
        --*)
            case "$option" in
                --self-update) opt_selfupdate ;;
                --version) opt_version ;;
                --help) opt_help ;;
                *) err "Invalid option: ${option}" ;;
            esac
        ;;
        -*)
            case "$option" in
                -v) opt_version ;;
                -h) opt_help ;;
                *) err "Invalid option: ${option}" ;;
            esac
        ;;
        "") opt_help ;;
        *) err "Invalid option: ${option}" ;;
    esac
}


main() {
    # Initalize directory paths
    init_paths || err "Failed to initialize script paths"

    # Remove old log file
    [[ -f "${LOG_PATH}" ]] && m_rm -f "${LOG_PATH}"

    load_config

    # Environment variable
    export WINEDEBUG="${CONFIG[winedebug]}"

    # Handle command line arguments
    handle_opts "$@"
}

# Main entry
main "$@"
m_exit 0
